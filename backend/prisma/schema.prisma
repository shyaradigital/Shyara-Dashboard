// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  userId    String   @unique // e.g., "admin.shyara"
  email     String   @unique
  name      String
  phone     String?
  password  String   // Hashed password
  role      String   @default("MANAGER") // ADMIN, MANAGER, or custom role name
  status    String   @default("active") // active, disabled
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?

  // Relations
  incomes      Income[]
  expenses     Expense[]
  documents    Document[]
  journalsCreated Journal[] @relation("JournalCreatedBy")
  journalsAssigned Journal[] @relation("JournalAssignedTo")

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  permissions String[] // Array of permission strings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roles")
}

model Income {
  id          String   @id @default(cuid())
  amount      Float
  category    String   // SMM, Website, Ads, POS, Consultation, Freelancing, Other
  source      String
  description String?
  date        DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Advance payment and dues fields
  totalAmount   Float?   // Total project/transaction amount
  advanceAmount Float?   @default(0) // Amount paid as advance
  dueAmount     Float?   @default(0) // Remaining amount due
  dueDate       DateTime? // Expected payment date for dues
  isDuePaid     Boolean  @default(false) // Whether the due has been paid
  duePaidDate   DateTime? // Date when due was paid

  // Relations
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("incomes")
}

model Expense {
  id          String   @id @default(cuid())
  amount      Float
  category    String   // Salaries, Subscriptions, Rent, Software, Hardware, Travel, Utilities, Misc
  purpose     String
  description String?
  date        DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("expenses")
}

enum DocumentType {
  INVOICE
  QUOTATION
}

enum DocumentStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Document {
  id            String         @id @default(cuid())
  documentType  DocumentType  @default(INVOICE)
  documentNumber String        // e.g., "STS/SD/2025/1611"
  businessUnit  String         // SD, SM, BX
  invoiceDate   DateTime
  dueDate       DateTime?
  placeOfSupply String?
  currency      String         @default("INR (â‚¹)")
  client        Json           // Client object as JSON
  services      Json           // Services array as JSON
  poRef         String?
  paymentTerms  String?
  notes         String?
  subtotal      Float
  totalDiscount Float          @default(0)
  grandTotal    Float
  status        DocumentStatus @default(DRAFT)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  userId        String?
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([documentType, businessUnit, documentNumber])
  @@index([businessUnit])
  @@index([documentType])
  @@index([status])
  @@index([invoiceDate])
  @@map("documents")
}

enum JournalType {
  TASK
  NOTE
}

model Journal {
  id          String      @id @default(cuid())
  title       String
  content     String
  type        JournalType
  deadline    DateTime?
  isCompleted Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  createdById String
  createdBy   User        @relation("JournalCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  assignedToId String?
  assignedTo  User?       @relation("JournalAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([isCompleted])
  @@index([deadline])
  @@index([createdById])
  @@index([assignedToId])
  @@index([createdAt])
  @@map("journals")
}

